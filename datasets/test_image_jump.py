#!/usr/bin/env python3
"""
æµ‹è¯•å›¾åƒè·³è½¬åŠŸèƒ½
"""

import requests
import time
from pathlib import Path

def test_image_jump():
    """æµ‹è¯•å›¾åƒè·³è½¬åŠŸèƒ½"""
    print("ğŸ§ª æµ‹è¯•å›¾åƒè·³è½¬åŠŸèƒ½")
    print("=" * 50)
    
    # æµ‹è¯•æ ‡å‡†ç‰ˆæœ¬
    print("\nğŸ“‹ æµ‹è¯•æ ‡å‡†ç‰ˆæœ¬ (ç«¯å£ 9090)")
    test_version("http://localhost:9090", "æ ‡å‡†ç‰ˆæœ¬")
    
    # æµ‹è¯•é«˜ç²¾åº¦ç‰ˆæœ¬
    print("\nğŸ“‹ æµ‹è¯•é«˜ç²¾åº¦ç‰ˆæœ¬ (ç«¯å£ 9092)")
    test_version("http://localhost:9092", "é«˜ç²¾åº¦ç‰ˆæœ¬")

def test_version(base_url, version_name):
    """æµ‹è¯•æŒ‡å®šç‰ˆæœ¬çš„å›¾åƒè·³è½¬åŠŸèƒ½"""
    try:
        # æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
        response = requests.get(f"{base_url}/api/directories", timeout=5)
        if response.status_code != 200:
            print(f"âŒ {version_name} æœåŠ¡å™¨æœªè¿è¡Œ")
            return
        print(f"âœ… {version_name} æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ")
        
        # è®¾ç½®ç›®å½•
        setup_data = {
            "images_dir": "datasets/coco8/images/train",
            "labels_dir": "datasets/coco8/labels/train"
        }
        response = requests.post(f"{base_url}/api/set-directories", json=setup_data)
        if response.status_code == 200:
            print(f"âœ… {version_name} ç›®å½•è®¾ç½®æˆåŠŸ")
        else:
            print(f"âŒ {version_name} ç›®å½•è®¾ç½®å¤±è´¥")
            return
        
        # è·å–å›¾åƒåˆ—è¡¨
        response = requests.get(f"{base_url}/api/images")
        if response.status_code == 200:
            images = response.json()
            if images:
                print(f"âœ… {version_name} æ‰¾åˆ° {len(images)} ä¸ªå›¾åƒ")
                
                # æµ‹è¯•å›¾åƒè·³è½¬åŠŸèƒ½
                test_image_jump_features(base_url, version_name, len(images))
            else:
                print(f"âŒ {version_name} æ²¡æœ‰æ‰¾åˆ°å›¾åƒ")
        else:
            print(f"âŒ {version_name} è·å–å›¾åƒåˆ—è¡¨å¤±è´¥")
            
    except requests.exceptions.RequestException as e:
        print(f"âŒ {version_name} è¿æ¥å¤±è´¥: {e}")

def test_image_jump_features(base_url, version_name, total_images):
    """æµ‹è¯•å›¾åƒè·³è½¬åŠŸèƒ½"""
    print(f"\nğŸ¯ æµ‹è¯• {version_name} å›¾åƒè·³è½¬åŠŸèƒ½")
    print("-" * 40)
    
    print(f"ğŸ’¡ æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤:")
    print(f"1. è®¿é—® {base_url}")
    print(f"2. ç‚¹å‡»'ğŸ“ åŠ è½½å›¾åƒ'æŒ‰é’®åŠ è½½å›¾åƒåˆ—è¡¨")
    print(f"3. æ£€æŸ¥è·³è½¬åŠŸèƒ½ç•Œé¢:")
    print(f"   ğŸ® è·³è½¬æ§åˆ¶åŒºåŸŸ:")
    print(f"      - æ•°å­—è¾“å…¥æ¡† (æ˜¾ç¤ºå½“å‰å›¾åƒç¼–å·)")
    print(f"      - ğŸ¯ è·³è½¬æŒ‰é’®")
    print(f"      - è¾“å…¥æ¡†å ä½ç¬¦æ˜¾ç¤º '1-{total_images}'")
    print(f"4. æµ‹è¯•è·³è½¬åŠŸèƒ½:")
    print(f"   ğŸ“‹ åŸºæœ¬è·³è½¬æµ‹è¯•:")
    print(f"      - åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ '1'ï¼Œç‚¹å‡»è·³è½¬æŒ‰é’®")
    print(f"      - éªŒè¯æ˜¯å¦è·³è½¬åˆ°ç¬¬1å¼ å›¾åƒ")
    print(f"      - åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ '{total_images//2}'ï¼Œç‚¹å‡»è·³è½¬æŒ‰é’®")
    print(f"      - éªŒè¯æ˜¯å¦è·³è½¬åˆ°ä¸­é—´å›¾åƒ")
    print(f"      - åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ '{total_images}'ï¼Œç‚¹å‡»è·³è½¬æŒ‰é’®")
    print(f"      - éªŒè¯æ˜¯å¦è·³è½¬åˆ°æœ€åä¸€å¼ å›¾åƒ")
    print(f"   ğŸ” è¾¹ç•Œæµ‹è¯•:")
    print(f"      - è¾“å…¥ '0'ï¼ŒéªŒè¯æ˜¯å¦æ˜¾ç¤ºé”™è¯¯æç¤º")
    print(f"      - è¾“å…¥ '{total_images + 1}'ï¼ŒéªŒè¯æ˜¯å¦æ˜¾ç¤ºé”™è¯¯æç¤º")
    print(f"      - è¾“å…¥éæ•°å­—å­—ç¬¦ï¼ŒéªŒè¯æ˜¯å¦æ˜¾ç¤ºé”™è¯¯æç¤º")
    print(f"   ğŸ”„ åŒæ­¥æµ‹è¯•:")
    print(f"      - ä½¿ç”¨'â¬…ï¸ ä¸Šä¸€å¼ 'æŒ‰é’®ï¼ŒéªŒè¯è¾“å…¥æ¡†æ˜¯å¦åŒæ­¥æ›´æ–°")
    print(f"      - ä½¿ç”¨'â¡ï¸ ä¸‹ä¸€å¼ 'æŒ‰é’®ï¼ŒéªŒè¯è¾“å…¥æ¡†æ˜¯å¦åŒæ­¥æ›´æ–°")
    print(f"      - è·³è½¬åˆ°å…¶ä»–å›¾åƒåï¼ŒéªŒè¯ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦æ›´æ–°")
    print(f"5. éªŒè¯åŠŸèƒ½æ•ˆæœ:")
    print(f"   - è·³è½¬åŠŸèƒ½æ­£å¸¸å·¥ä½œ")
    print(f"   - è¾“å…¥æ¡†å®æ—¶åŒæ­¥å½“å‰å›¾åƒç¼–å·")
    print(f"   - é”™è¯¯è¾“å…¥æœ‰é€‚å½“çš„æç¤º")
    print(f"   - è·³è½¬åè‡ªåŠ¨å¤åˆ¶åŠŸèƒ½æ­£å¸¸")

def create_image_jump_instructions():
    """åˆ›å»ºå›¾åƒè·³è½¬åŠŸèƒ½è¯´æ˜"""
    instructions = """
# å›¾åƒè·³è½¬åŠŸèƒ½è¯´æ˜

## ğŸ¯ åŠŸèƒ½æè¿°

ä¸ºæ ‡æ³¨å·¥å…·æ·»åŠ å›¾åƒè·³è½¬åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·ç›´æ¥è·³è½¬åˆ°æŒ‡å®šçš„å›¾åƒï¼Œè€Œä¸éœ€è¦é€å¼ åˆ‡æ¢ã€‚æé«˜æ ‡æ³¨æ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆå¤§é‡å›¾åƒçš„æ‰¹é‡å¤„ç†ã€‚

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. ç•Œé¢ç»„ä»¶

**è·³è½¬æ§åˆ¶åŒºåŸŸåŒ…å«ï¼š**
- æ•°å­—è¾“å…¥æ¡†ï¼šæ˜¾ç¤ºå½“å‰å›¾åƒç¼–å·ï¼Œå…è®¸ç”¨æˆ·è¾“å…¥ç›®æ ‡å›¾åƒç¼–å·
- è·³è½¬æŒ‰é’®ï¼šæ‰§è¡Œè·³è½¬æ“ä½œ
- å®æ—¶åŒæ­¥ï¼šè¾“å…¥æ¡†è‡ªåŠ¨æ›´æ–°å½“å‰å›¾åƒç¼–å·

### 2. åŠŸèƒ½ç‰¹æ€§

#### åŸºæœ¬åŠŸèƒ½
- **ç›´æ¥è·³è½¬**ï¼šè¾“å…¥å›¾åƒç¼–å·ç›´æ¥è·³è½¬åˆ°æŒ‡å®šå›¾åƒ
- **ç¼–å·æ˜¾ç¤º**ï¼šè¾“å…¥æ¡†æ˜¾ç¤ºå½“å‰å›¾åƒç¼–å·ï¼ˆ1åŸºç´¢å¼•ï¼‰
- **èŒƒå›´é™åˆ¶**ï¼šè¾“å…¥æ¡†é™åˆ¶åœ¨æœ‰æ•ˆèŒƒå›´å†…ï¼ˆ1åˆ°æ€»å›¾åƒæ•°ï¼‰
- **å®æ—¶åŒæ­¥**ï¼šä½¿ç”¨ä¸Šä¸€å¼ /ä¸‹ä¸€å¼ æŒ‰é’®æ—¶è¾“å…¥æ¡†è‡ªåŠ¨æ›´æ–°

#### é”™è¯¯å¤„ç†
- **èŒƒå›´éªŒè¯**ï¼šæ£€æŸ¥è¾“å…¥æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
- **ç±»å‹éªŒè¯**ï¼šæ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
- **é”™è¯¯æç¤º**ï¼šæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯

#### é›†æˆåŠŸèƒ½
- **è‡ªåŠ¨å¤åˆ¶**ï¼šè·³è½¬æ—¶ä¿å­˜å½“å‰å›¾åƒæ ‡æ³¨ç”¨äºè‡ªåŠ¨å¤åˆ¶
- **ç»Ÿè®¡æ›´æ–°**ï¼šè·³è½¬åæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- **çŠ¶æ€åŒæ­¥**ï¼šä¿æŒæ‰€æœ‰ç•Œé¢å…ƒç´ çŠ¶æ€ä¸€è‡´

## ğŸ¨ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### æ–°å¢åŠŸèƒ½
- âœ… ç›´æ¥è·³è½¬åˆ°æŒ‡å®šå›¾åƒ
- âœ… å¿«é€Ÿè®¿é—®ä»»æ„å›¾åƒ
- âœ… æé«˜æ‰¹é‡å¤„ç†æ•ˆç‡
- âœ… å‡å°‘é‡å¤æ“ä½œ

### æ“ä½œä¾¿åˆ©æ€§
- âœ… è¾“å…¥æ¡†å®æ—¶æ˜¾ç¤ºå½“å‰å›¾åƒç¼–å·
- âœ… å ä½ç¬¦æç¤ºæœ‰æ•ˆèŒƒå›´
- âœ… ä¸€é”®è·³è½¬æ“ä½œ
- âœ… é”™è¯¯è¾“å…¥å‹å¥½æç¤º

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•
- [ ] è¾“å…¥æœ‰æ•ˆç¼–å·è·³è½¬æˆåŠŸ
- [ ] è·³è½¬åˆ°ç¬¬ä¸€å¼ å›¾åƒ
- [ ] è·³è½¬åˆ°ä¸­é—´å›¾åƒ
- [ ] è·³è½¬åˆ°æœ€åä¸€å¼ å›¾åƒ
- [ ] è·³è½¬åå›¾åƒæ­£ç¡®æ˜¾ç¤º

### 2. è¾¹ç•Œæµ‹è¯•
- [ ] è¾“å…¥0æ˜¾ç¤ºé”™è¯¯æç¤º
- [ ] è¾“å…¥è¶…å‡ºèŒƒå›´ç¼–å·æ˜¾ç¤ºé”™è¯¯æç¤º
- [ ] è¾“å…¥éæ•°å­—å­—ç¬¦æ˜¾ç¤ºé”™è¯¯æç¤º
- [ ] ç©ºè¾“å…¥å¤„ç†æ­£å¸¸

### 3. åŒæ­¥æµ‹è¯•
- [ ] ä½¿ç”¨ä¸Šä¸€å¼ æŒ‰é’®è¾“å…¥æ¡†åŒæ­¥æ›´æ–°
- [ ] ä½¿ç”¨ä¸‹ä¸€å¼ æŒ‰é’®è¾“å…¥æ¡†åŒæ­¥æ›´æ–°
- [ ] è·³è½¬åç»Ÿè®¡ä¿¡æ¯æ­£ç¡®æ›´æ–°
- [ ] è·³è½¬åæ ‡æ³¨åˆ—è¡¨æ­£ç¡®æ›´æ–°

### 4. é›†æˆæµ‹è¯•
- [ ] è·³è½¬æ—¶è‡ªåŠ¨å¤åˆ¶åŠŸèƒ½æ­£å¸¸
- [ ] è·³è½¬åä¿å­˜åŠŸèƒ½æ­£å¸¸
- [ ] è·³è½¬åæ¸…é™¤åŠŸèƒ½æ­£å¸¸
- [ ] æ‰€æœ‰æŒ‰é’®åŠŸèƒ½æ­£å¸¸

## ğŸ“‹ å®ç°ç»†èŠ‚

### HTMLç»“æ„
```html
<div class="jump-controls">
    <input type="number" id="jump-input" placeholder="å›¾åƒç¼–å·" min="1" max="1" class="jump-input">
    <button class="btn-info" onclick="jumpToImage()">ğŸ¯ è·³è½¬</button>
</div>
```

### CSSæ ·å¼
```css
.jump-controls {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin: 0 10px;
}

.jump-input {
    width: 80px;
    padding: 8px 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    text-align: center;
}
```

### JavaScriptåŠŸèƒ½
```javascript
function jumpToImage() {
    const jumpInput = document.getElementById('jump-input');
    const targetIndex = parseInt(jumpInput.value) - 1;
    
    if (isNaN(targetIndex) || targetIndex < 0 || targetIndex >= images.length) {
        showError(`è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾åƒç¼–å· (1-${images.length})`);
        return;
    }
    
    saveCurrentAnnotations();
    currentIndex = targetIndex;
    loadCurrentImage();
    updateStats();
    updateJumpInput();
    showSuccess(`å·²è·³è½¬åˆ°ç¬¬ ${targetIndex + 1} å¼ å›¾åƒ`);
}

function updateJumpInput() {
    const jumpInput = document.getElementById('jump-input');
    if (jumpInput) {
        jumpInput.value = currentIndex + 1;
        jumpInput.max = images.length;
        jumpInput.placeholder = `1-${images.length}`;
    }
}
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### é€‚ç”¨åœºæ™¯
1. **æ‰¹é‡æ ‡æ³¨**ï¼šå¿«é€Ÿè·³è½¬åˆ°éœ€è¦æ ‡æ³¨çš„å›¾åƒ
2. **è´¨é‡æ£€æŸ¥**ï¼šè·³è½¬åˆ°ç‰¹å®šå›¾åƒè¿›è¡ŒéªŒè¯
3. **é”™è¯¯ä¿®æ­£**ï¼šå¿«é€Ÿå®šä½åˆ°æœ‰é—®é¢˜çš„å›¾åƒ
4. **è¿›åº¦ç®¡ç†**ï¼šè·³è½¬åˆ°ç‰¹å®šè¿›åº¦ä½ç½®

### ç”¨æˆ·å—ç›Š
1. **æ•ˆç‡æå‡**ï¼šæ— éœ€é€å¼ åˆ‡æ¢å›¾åƒ
2. **æ“ä½œä¾¿åˆ©**ï¼šç›´æ¥è¾“å…¥ç¼–å·è·³è½¬
3. **æ—¶é—´èŠ‚çœ**ï¼šå‡å°‘é‡å¤æ“ä½œæ—¶é—´
4. **å·¥ä½œæµç¨‹**ï¼šæ”¯æŒçµæ´»çš„æ ‡æ³¨ç­–ç•¥

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ç¼–å·ç³»ç»Ÿ**ï¼šä½¿ç”¨1åŸºç´¢å¼•æ˜¾ç¤ºï¼Œå†…éƒ¨ä½¿ç”¨0åŸºç´¢å¼•
2. **æ•°æ®åŒæ­¥**ï¼šè·³è½¬æ—¶ä¿å­˜å½“å‰å›¾åƒæ ‡æ³¨
3. **é”™è¯¯å¤„ç†**ï¼šæä¾›å‹å¥½çš„é”™è¯¯æç¤º
4. **æ€§èƒ½è€ƒè™‘**ï¼šè·³è½¬æ“ä½œè½»é‡çº§ï¼Œæ€§èƒ½å½±å“å°

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `datasets/web_annotation_tool.py` - æ ‡å‡†ç‰ˆæœ¬
- `datasets/web_annotation_tool_enhanced.py` - é«˜ç²¾åº¦ç‰ˆæœ¬

### æµ‹è¯•æ–‡ä»¶
- `datasets/test_image_jump.py` - å›¾åƒè·³è½¬åŠŸèƒ½æµ‹è¯•è„šæœ¬
- `datasets/IMAGE_JUMP_INSTRUCTIONS.md` - æœ¬åŠŸèƒ½è¯´æ˜

## ğŸ‰ æ€»ç»“

å›¾åƒè·³è½¬åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼Œä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š

1. **åŠŸèƒ½å¢å¼º**ï¼šæ·»åŠ ç›´æ¥è·³è½¬åˆ°æŒ‡å®šå›¾åƒçš„èƒ½åŠ›
2. **æ•ˆç‡æå‡**ï¼šå‡å°‘é€å¼ åˆ‡æ¢çš„æ“ä½œæ—¶é—´
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›ç›´è§‚çš„è·³è½¬ç•Œé¢
4. **é›†æˆå®Œå–„**ï¼šä¸ç°æœ‰åŠŸèƒ½å®Œç¾é›†æˆ

è¿™ä¸ªåŠŸèƒ½è®©æ ‡æ³¨å·¥å…·çš„ä½¿ç”¨æ›´åŠ é«˜æ•ˆå’Œçµæ´»ï¼Œç‰¹åˆ«é€‚åˆéœ€è¦å¤„ç†å¤§é‡å›¾åƒçš„åœºæ™¯ã€‚
"""
    
    with open("datasets/IMAGE_JUMP_INSTRUCTIONS.md", "w", encoding="utf-8") as f:
        f.write(instructions)
    
    print("ğŸ“„ å·²åˆ›å»ºå›¾åƒè·³è½¬åŠŸèƒ½è¯´æ˜æ–‡æ¡£: datasets/IMAGE_JUMP_INSTRUCTIONS.md")

def main():
    print("ğŸ¯ å›¾åƒè·³è½¬åŠŸèƒ½æµ‹è¯•")
    print("=" * 60)
    
    # æµ‹è¯•å›¾åƒè·³è½¬åŠŸèƒ½
    test_image_jump()
    
    # åˆ›å»ºåŠŸèƒ½è¯´æ˜
    create_image_jump_instructions()
    
    print("\nğŸ‰ æµ‹è¯•å®Œæˆï¼")
    print("\nğŸ’¡ ä½¿ç”¨å»ºè®®:")
    print("1. è®¿é—®æ ‡æ³¨å·¥å…·æŸ¥çœ‹æ–°çš„è·³è½¬åŠŸèƒ½")
    print("2. æµ‹è¯•ç›´æ¥è·³è½¬åˆ°æŒ‡å®šå›¾åƒ")
    print("3. éªŒè¯è¾“å…¥æ¡†åŒæ­¥æ›´æ–°åŠŸèƒ½")
    print("4. ç¡®è®¤è·³è½¬åŠŸèƒ½æé«˜æ ‡æ³¨æ•ˆç‡")

if __name__ == '__main__':
    main()

<!DOCTYPE html>
<html>
<head>
    <title>ç®€å•æ ‡æ³¨æµ‹è¯•</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-area { border: 2px solid #ccc; width: 400px; height: 300px; position: relative; margin: 20px 0; }
        .annotation { position: absolute; border: 2px solid red; background: rgba(255,0,0,0.1); }
        .controls { margin: 20px 0; }
        .btn { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ç®€å•æ ‡æ³¨æµ‹è¯•</h1>
    
    <div class="controls">
        <button class="btn" onclick="addAnnotation()">æ·»åŠ æ ‡æ³¨</button>
        <button class="btn" onclick="saveAnnotations()">ä¿å­˜æ ‡æ³¨</button>
        <button class="btn" onclick="loadAnnotations()">åŠ è½½æ ‡æ³¨</button>
        <button class="btn" onclick="clearAnnotations()">æ¸…ç©ºæ ‡æ³¨</button>
    </div>
    
    <div class="log" id="log">
        æ ‡æ³¨æ•°é‡: <span id="count">0</span><br>
        æ ‡æ³¨æ•°æ®: <span id="data">[]</span>
    </div>
    
    <div class="test-area" id="test-area">
        <p>ç‚¹å‡»"æ·»åŠ æ ‡æ³¨"æŒ‰é’®æµ‹è¯•</p>
    </div>
    
    <script>
        let annotations = [];
        let annotationCount = 0;
        
        function log(message) {
            console.log(message);
            document.getElementById('log').innerHTML += message + '<br>';
        }
        
        function updateDisplay() {
            document.getElementById('count').textContent = annotations.length;
            document.getElementById('data').textContent = JSON.stringify(annotations);
        }
        
        function addAnnotation() {
            annotationCount++;
            const annotation = {
                id: annotationCount,
                x: Math.random() * 0.7,
                y: Math.random() * 0.7,
                width: 0.1 + Math.random() * 0.2,
                height: 0.1 + Math.random() * 0.2,
                class: 'watermark'
            };
            
            log(`â• æ·»åŠ æ ‡æ³¨ ${annotationCount}: ${JSON.stringify(annotation)}`);
            log(`ğŸ“Š æ·»åŠ å‰: ${annotations.length} ä¸ªæ ‡æ³¨`);
            
            annotations.push(annotation);
            
            log(`ğŸ“Š æ·»åŠ å: ${annotations.length} ä¸ªæ ‡æ³¨`);
            log(`ğŸ“‹ å½“å‰æ‰€æœ‰æ ‡æ³¨: ${JSON.stringify(annotations)}`);
            
            updateDisplay();
            drawAnnotations();
        }
        
        function drawAnnotations() {
            const area = document.getElementById('test-area');
            // æ¸…é™¤ç°æœ‰æ ‡æ³¨
            const existing = area.querySelectorAll('.annotation');
            existing.forEach(el => el.remove());
            
            // ç»˜åˆ¶æ–°æ ‡æ³¨
            annotations.forEach((annotation, index) => {
                const div = document.createElement('div');
                div.className = 'annotation';
                div.style.left = (annotation.x * 400) + 'px';
                div.style.top = (annotation.y * 300) + 'px';
                div.style.width = (annotation.width * 400) + 'px';
                div.style.height = (annotation.height * 300) + 'px';
                div.textContent = annotation.id;
                area.appendChild(div);
            });
        }
        
        async function saveAnnotations() {
            log(`ğŸ’¾ å¼€å§‹ä¿å­˜ ${annotations.length} ä¸ªæ ‡æ³¨`);
            log(`ğŸ“‹ ä¿å­˜æ•°æ®: ${JSON.stringify(annotations)}`);
            
            try {
                const response = await fetch('/api/save/test_image.jpg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(annotations)
                });
                
                log(`ğŸ“¡ ä¿å­˜å“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`âœ… ä¿å­˜æˆåŠŸ: ${JSON.stringify(result)}`);
                } else {
                    log(`âŒ ä¿å­˜å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ ä¿å­˜å¼‚å¸¸: ${error.message}`);
            }
        }
        
        async function loadAnnotations() {
            log(`ğŸ”„ å¼€å§‹åŠ è½½æ ‡æ³¨`);
            log(`ğŸ“Š åŠ è½½å‰: ${annotations.length} ä¸ªæ ‡æ³¨`);
            
            try {
                const response = await fetch('/api/labels/test_image.jpg');
                log(`ğŸ“¡ åŠ è½½å“åº”çŠ¶æ€: ${response.status}`);
                
                if (response.ok) {
                    const loadedAnnotations = await response.json();
                    log(`ğŸ“¥ åŠ è½½åˆ°çš„æ ‡æ³¨: ${JSON.stringify(loadedAnnotations)}`);
                    log(`ğŸ“Š åŠ è½½å: ${loadedAnnotations.length} ä¸ªæ ‡æ³¨`);
                    
                    annotations = loadedAnnotations;
                    updateDisplay();
                    drawAnnotations();
                } else {
                    log(`ğŸ“„ æ ‡æ³¨æ–‡ä»¶ä¸å­˜åœ¨`);
                }
            } catch (error) {
                log(`âŒ åŠ è½½å¼‚å¸¸: ${error.message}`);
            }
        }
        
        function clearAnnotations() {
            log(`ğŸ—‘ï¸ æ¸…ç©ºæ ‡æ³¨`);
            annotations = [];
            updateDisplay();
            drawAnnotations();
        }
        
        // åˆå§‹åŒ–
        updateDisplay();
        log('ğŸš€ ç®€å•æ ‡æ³¨æµ‹è¯•å·²å¯åŠ¨');
    </script>
</body>
</html>

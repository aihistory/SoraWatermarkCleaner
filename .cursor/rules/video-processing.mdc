---
globs: sorawm/utils/video_utils.py,sorawm/core.py
---

# 视频处理规范

## 视频处理流程
参考 [sorawm/core.py](mdc:sorawm/core.py) 的 `SoraWM.run()` 方法：

1. **视频加载**: 使用 [sorawm/utils/video_utils.py](mdc:sorawm/utils/video_utils.py) 的 `VideoLoader`
2. **帧检测**: 逐帧进行水印检测
3. **插值处理**: 填充未检测到的帧
4. **水印移除**: 使用 LAMA 模型清理水印
5. **视频编码**: 使用 FFmpeg 重新编码
6. **音频合并**: 保留原始音频轨道

## FFmpeg 集成
- **编码参数**: 使用高质量编码设置 (CRF 18, preset slow)
- **格式支持**: 支持 MP4, AVI, MOV, MKV 等格式
- **音频处理**: 自动检测和保留音频轨道
- **临时文件**: 使用临时文件避免内存溢出

## 性能优化
- **流式处理**: 逐帧处理避免内存溢出
- **进度回调**: 实时进度更新 (10% - 95%)
- **内存管理**: 及时释放帧数据
- **并行处理**: 支持多进程处理

## 错误处理
- **格式验证**: 检查输入视频格式和编码
- **文件权限**: 确保输出目录可写
- **资源清理**: 异常时清理临时文件
- **日志记录**: 详细的处理日志

## 质量保证
- **比特率保持**: 保持原始视频质量
- **分辨率保持**: 不改变视频分辨率
- **帧率保持**: 保持原始帧率
- **色彩空间**: 正确处理色彩空间转换

## 支持的视频格式
- **输入**: MP4, AVI, MOV, MKV, WebM
- **输出**: MP4 (H.264 编码)
- **音频**: AAC 编码
- **像素格式**: YUV420P (兼容性最佳)